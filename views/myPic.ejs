<%- include('layout') %>

<div class="container">
  <h1>My Pictures</h1>

  <% if (images && images.length > 0) { %>
    <div class="row" id="masonry-grid">
      <% images.forEach(image => { %>
        <div class="col s12 m6 l4 masonry-item">
          <div class="card">
            <div class="card-image">
              <img src="<%= image.url %>" alt="<%= image.description %>">
            </div>
            <div class="card-content">
              <p>
                <%= image.description %>
              </p>
              <div class="stars-container">
                <i class="material-icons">star</i> <%= image.stars %>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>You have not uploaded any pictures yet.</p>
  <% } %>

  <a href="/add-a-pic" class="waves-effect waves-light btn">Add a Picture</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>

<script>
  // Inisialisasi Masonry
  const grid = document.getElementById('masonry-grid');
  const msnry = new Masonry(grid, {
    itemSelector: '.masonry-item',
    columnWidth: '.masonry-item',
    // gutter: 10,
  });

  // Fungsi untuk mengganti gambar yang rusak dan memicu layout ulang
  function replaceBrokenImage(imgElement) {
    imgElement.src = 'No-Image-Placeholder.png'; // Ganti dengan placeholder
    imgElement.onload = function() {
      msnry.layout(); // Perbarui Masonry setelah gambar pengganti termuat
    };
  }

  // Deteksi gambar yang error
  const allImages = document.querySelectorAll('img');
  allImages.forEach(img => {
    img.onerror = function() {
      replaceBrokenImage(this); // Ganti gambar yang error
    };
    img.onload = function() {
      msnry.layout(); // Perbarui Masonry setelah gambar asli termuat
    };
  });

  // Trigger layout Masonry setelah semua gambar asli atau placeholder selesai dimuat
  window.addEventListener('load', function () {
    msnry.layout();
  });
</script>
